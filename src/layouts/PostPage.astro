---
import type { CollectionEntry } from 'astro:content'
import BaseLayout from '@/layouts/BaseLayout.astro'
import FormattedDate from '@/components/FormattedDate.astro'
import Divider from '@/components/Divider.astro'
import { SITE_DESCRIPTION } from '@/consts'
import TablerPencil from '~icons/tabler/pencil'
import { getCollection } from 'astro:content'
import PostCard from '@/components/PostCard.astro'

interface Data {
  updatedDate?: Date | undefined
  heroImage?: string | undefined
  title: string
  description?: string
  date?: Date
  draft?: boolean
}

interface Props {
  data: Data
  slug: CollectionEntry<'blog'>['slug'] | string
  isShowDate?: boolean
  isBlogPost?: boolean
}

const { data, slug, isShowDate = true, isBlogPost = false } = Astro.props

const posts = (await getCollection('blog')).sort(
  (a, b) => a.data.date.valueOf() - b.data.date.valueOf(),
)

const resultIsShowDate =
  !data?.draft && isShowDate && (data?.date || data?.updatedDate)
const resultTitle = data.title
const resultDescription = data?.description
const hasHeroImage = Boolean(data?.heroImage)
const resultImage = data?.heroImage || `/image/${slug}.png`
console.log(Astro.props)
---

<BaseLayout
  title={resultTitle}
  description={resultDescription || SITE_DESCRIPTION}
  image={resultImage}
  slug={slug}
>
  <article class:list={[{ isBlogPost }]}>
    <div class="pageInfo flex flex-col gap-3">
      {hasHeroImage && <img src={resultImage} alt="Hero image" />}
      <!-- {resultImage && <img src={resultImage} alt="Hero image" />} -->
      <h1 class="mb-0">{resultTitle}</h1>
      {resultDescription && <p class="opacity-70 m-0">{resultDescription}</p>}

      {
        resultIsShowDate && (
          <div class="flex flex-row flex-wrap gap-x-3 gap-y-0.3 opacity-70">
            {data?.date && <FormattedDate date={data?.date} />}
            {data?.updatedDate && (
              <FormattedDate date={data?.updatedDate} isUpdatedDate={true} />
            )}
          </div>
        )
      }
      {
        data?.draft && (
          <p class="m-0 inline-flex items-center gap-1 text-lg">
            <TablerPencil class="w-1em h-1em" />
            Черновик
          </p>
        )
      }
      <Divider article={false} />
    </div>
    <div class="articleContent">
      <slot />
    </div>
  </article>
  {
    isBlogPost && (
      <div>
        <div class="mt-20 mb-12 my-2">
          <Divider article={false} />
        </div>
        <section>
          <p class="text-xl">Вам также может понравиться:</p>
          <div class="my-4 p-0 grid grid-cols-1 md:grid-cols-3 gap-4">
            {posts
              .slice()
              .filter((post) => !post.data.draft)
              .reverse()
              .slice(0, 6)
              .map((post) => (
                <PostCard post={post} />
              ))}
          </div>
        </section>
      </div>
    )
  }
</BaseLayout>
